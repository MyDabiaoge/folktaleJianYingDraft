import json
from pprint import pprint

from LLM.doubao_chat import chat
from common.model import Role, Scenes, Story
from common.utils import role_serializer, scenes_serializer


def create_v_prompt(story_id: int):
    ##test
    # str = """[{"caption": "有个落榜书生，心灰意冷，半夜跑去跳井。",
    #   "index": 1,
    #   "prompt": "远景，一口古老的井位于画面中心，周围是寂静的黑夜，月光洒下，地面呈现暖棕色。落榜书生的身影在井边，落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发，身着破旧长衫；他脚步踉跄，眼神绝望，双手无力地垂在两侧，正朝着井口走去，整体画面是新国风工笔绘画风格，融合传统工笔画的线条细腻感与现代数字艺术的精致感，以暖棕、青绿等传统色系为主，营造古朴年代感，采用柔和的平光处理，无强烈明暗对比，通过色彩层次和线条质感表现体积，营造出宁静古朴的氛围"},
    #  {"caption": "就在他要跳下时，井里突然冒出个白胡子仙人。",
    #   "index": 2,
    #   "prompt": "中景，画面中心是井口，落榜书生站在井口边缘，一只脚已经抬起，落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发，身着破旧长衫；此时他满脸惊恐。井里冒出白胡子仙人，白胡子仙人固定特征：年龄约80岁，五官慈祥、白眉白须，体态清瘦，肤色红润，发型白发苍苍，身着白色道袍；仙人双手抬起，面带微笑，正缓缓从井中升起。周围的夜色以暖棕和深蓝为主色调，体现出古朴的氛围，画面采用新国风工笔绘画风格，线条细腻，有木刻版画的复古质感，构图为中心构图，人物立于中轴位置，柔和的平光让画面无强烈明暗对比"},
    #  {"caption": "仙人说：‘年轻人，一次落榜算啥。’",
    #   "index": 3,
    #   "prompt": "近景，画面中心白胡子仙人与落榜书生面对面。白胡子仙人固定特征：年龄约80岁，五官慈祥、白眉白须，体态清瘦，肤色红润，发型白发苍苍，身着白色道袍；他伸出一只手，轻轻拍着落榜书生的肩膀，面带微笑，眼神和蔼。落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发，身着破旧长衫；他微微低头，脸上露出惊讶和思索的神情。背景是井壁和朦胧的夜色，以暖棕和青绿色调为主，新国风工笔绘画风格，线条精致，色彩层次丰富，采用柔和平光，营造宁静古朴氛围"},
    #  {"caption": "书生听后醒悟。",
    #   "index": 4,
    #   "prompt": "近景，画面中心落榜书生抬起头，眼神逐渐明亮，落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发，身着破旧长衫；他的嘴角微微上扬，露出坚定的神情。白胡子仙人站在一旁，白胡子仙人固定特征：年龄约80岁，五官慈祥、白眉白须，体态清瘦，肤色红润，发型白发苍苍，身着白色道袍；微笑着点头。背景是井边的石头和淡淡的月光，以暖棕和淡蓝为主色调，新国风工笔绘画风格，线条细腻，色彩古朴，平光处理让画面柔和宁静"},
    #  {"caption": "殊不知，凡是看到这的人，只要留下一句‘金榜题名’，日后便会学业有成，前程似锦。",
    #   "index": 5,
    #   "prompt": "远景，画面中心是落榜书生和白胡子仙人站在井边，落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发，身着破旧长衫；此时他精神饱满。白胡子仙人固定特征：年龄约80岁，五官慈祥、白眉白须，体态清瘦，肤色红润，发型白发苍苍，身着白色道袍；站在一旁微笑。周围有一些虚幻的文字‘金榜题名’漂浮着，背景是夜晚的乡村景色，有房屋和树木，以暖棕、青绿等传统色系为主，新国风工笔绘画风格，线条精致，有木刻版画的复古感，构图为中心构图，柔和平光营造出古朴宁静的氛围"},
    #  {"caption": "书生后来努力，终得功名。",
    #   "index": 6,
    #   "prompt": "远景，画面中心是热闹的古代街道，人群欢呼。落榜书生此时身着崭新的红色官服，头戴乌纱帽，骑在高头大马上，落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发；此时他容光焕发，满脸喜悦。街道两旁是中式建筑，挂着红色的灯笼，以暖棕和红色为主色调，新国风工笔绘画风格，线条细腻，色彩鲜艳且有层次感，采用柔和平光，营造出喜庆古朴的氛围"}]"""
    # json_res = json.loads(str)
    # for item in json_res:
    #     item['story_id'] = story_id
    # return json_res
    ##test

    system_prompt = """
# 角色
影视剧本动作描述专员，擅长根据文字内容精准提炼并细致描述人物动作，为视频生成提供合适的AI提示词。
# 目标
1. 依据给定的文字内容，细致描述每个人物当前正在进行的第一个动作。
2. 将描述内容整理成适合作为生成视频的AI提示词。
# 技能
1. 具备敏锐的文字理解能力，能从文字中准确提取人物动作信息。
2. 掌握简洁且精准的语言表达技巧，以符合输出格式要求。
# 工作流程
1. 仔细阅读caption中的文字内容，标记出每个人物及其当前caption中的第一个正在进行的动作。
2. 对标记出的动作进行细致描述，确保描述准确、清晰。
3. 按照“人物身份：正在进行的动作”的格式，将多个人物的动作描述用逗号隔开进行整理。
4. 检查整理后的内容是否符合输出格式和约束要求，如有不符进行修改。
# 约束
1. 必须专注地描写动作，不得描述其他跟动作无关的内容。
2.动作必须是当前正在进行的，描述过去和未来的动作不考虑在内
3.要考虑动作的合理性，比如某一个动作不能两人都在进行
4.只描述当前进行的动作，不要描述动作带来的后果等其他内容
# 输出格式
输出必须为以下JSON结构。id对应scenes里的id。v_prompt是提示词:
[
    {
    "id":1,
    "v_prompt": "视频提示词"
    },{
    "id":2,
    "v_prompt": "视频提示词"
    }
]
# 示例

示例1：
输入：[{"id": 155, "caption": "就这么着，老头连着来了三四天。这天王大山实在忍不住了，擦着手凑过去：“大爷，您天天来瞅我宰牛，这糙活儿有啥看头啊？"}]
输出：
[
    {
    "id":1,
    "v_prompt": "老头：正在驻足观望，王大山：正在擦着手凑过去"
    }
]
    """
    story = Story.get_by_id(story_id)
    db_scenes = (Scenes.select(Scenes.id, Scenes.caption)
                 .where(Scenes.story_id == story_id)
                 .order_by(Scenes.index.asc())
                 .limit(story.video_scenes_num))
    scenes = [scenes_serializer(scene) for scene in db_scenes]
    user_prompt = f"""
"scenes":{json.dumps(scenes, ensure_ascii=False)}
"""
    res = chat(system_prompt, user_prompt)
    pprint(f"提示词请求返回：{res}")
    json_res = json.loads(res)
    for item in json_res:
        Scenes.update(v_prompt=item['v_prompt']).where(Scenes.id == item['id']).execute()
    pprint(f"生成提示词成功:{json_res}")
    
if __name__ == '__main__':
    story_id = input("请输入故事Id：")
    create_v_prompt(int(story_id))