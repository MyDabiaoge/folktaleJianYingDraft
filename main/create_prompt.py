import json
from pprint import pprint

from LLM.doubao_chat import chat
from common.model import Role, Scenes
from common.utils import role_serializer, scenes_serializer


def create_image_prompt(story_id: int):
    ##test
    # str = """[{"caption": "有个落榜书生，心灰意冷，半夜跑去跳井。",
    #   "index": 1,
    #   "prompt": "远景，一口古老的井位于画面中心，周围是寂静的黑夜，月光洒下，地面呈现暖棕色。落榜书生的身影在井边，落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发，身着破旧长衫；他脚步踉跄，眼神绝望，双手无力地垂在两侧，正朝着井口走去，整体画面是新国风工笔绘画风格，融合传统工笔画的线条细腻感与现代数字艺术的精致感，以暖棕、青绿等传统色系为主，营造古朴年代感，采用柔和的平光处理，无强烈明暗对比，通过色彩层次和线条质感表现体积，营造出宁静古朴的氛围"},
    #  {"caption": "就在他要跳下时，井里突然冒出个白胡子仙人。",
    #   "index": 2,
    #   "prompt": "中景，画面中心是井口，落榜书生站在井口边缘，一只脚已经抬起，落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发，身着破旧长衫；此时他满脸惊恐。井里冒出白胡子仙人，白胡子仙人固定特征：年龄约80岁，五官慈祥、白眉白须，体态清瘦，肤色红润，发型白发苍苍，身着白色道袍；仙人双手抬起，面带微笑，正缓缓从井中升起。周围的夜色以暖棕和深蓝为主色调，体现出古朴的氛围，画面采用新国风工笔绘画风格，线条细腻，有木刻版画的复古质感，构图为中心构图，人物立于中轴位置，柔和的平光让画面无强烈明暗对比"},
    #  {"caption": "仙人说：‘年轻人，一次落榜算啥。’",
    #   "index": 3,
    #   "prompt": "近景，画面中心白胡子仙人与落榜书生面对面。白胡子仙人固定特征：年龄约80岁，五官慈祥、白眉白须，体态清瘦，肤色红润，发型白发苍苍，身着白色道袍；他伸出一只手，轻轻拍着落榜书生的肩膀，面带微笑，眼神和蔼。落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发，身着破旧长衫；他微微低头，脸上露出惊讶和思索的神情。背景是井壁和朦胧的夜色，以暖棕和青绿色调为主，新国风工笔绘画风格，线条精致，色彩层次丰富，采用柔和平光，营造宁静古朴氛围"},
    #  {"caption": "书生听后醒悟。",
    #   "index": 4,
    #   "prompt": "近景，画面中心落榜书生抬起头，眼神逐渐明亮，落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发，身着破旧长衫；他的嘴角微微上扬，露出坚定的神情。白胡子仙人站在一旁，白胡子仙人固定特征：年龄约80岁，五官慈祥、白眉白须，体态清瘦，肤色红润，发型白发苍苍，身着白色道袍；微笑着点头。背景是井边的石头和淡淡的月光，以暖棕和淡蓝为主色调，新国风工笔绘画风格，线条细腻，色彩古朴，平光处理让画面柔和宁静"},
    #  {"caption": "殊不知，凡是看到这的人，只要留下一句‘金榜题名’，日后便会学业有成，前程似锦。",
    #   "index": 5,
    #   "prompt": "远景，画面中心是落榜书生和白胡子仙人站在井边，落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发，身着破旧长衫；此时他精神饱满。白胡子仙人固定特征：年龄约80岁，五官慈祥、白眉白须，体态清瘦，肤色红润，发型白发苍苍，身着白色道袍；站在一旁微笑。周围有一些虚幻的文字‘金榜题名’漂浮着，背景是夜晚的乡村景色，有房屋和树木，以暖棕、青绿等传统色系为主，新国风工笔绘画风格，线条精致，有木刻版画的复古感，构图为中心构图，柔和平光营造出古朴宁静的氛围"},
    #  {"caption": "书生后来努力，终得功名。",
    #   "index": 6,
    #   "prompt": "远景，画面中心是热闹的古代街道，人群欢呼。落榜书生此时身着崭新的红色官服，头戴乌纱帽，骑在高头大马上，落榜书生固定特征：年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发；此时他容光焕发，满脸喜悦。街道两旁是中式建筑，挂着红色的灯笼，以暖棕和红色为主色调，新国风工笔绘画风格，线条细腻，色彩鲜艳且有层次感，采用柔和平光，营造出喜庆古朴的氛围"}]"""
    # json_res = json.loads(str)
    # for item in json_res:
    #     item['story_id'] = story_id
    # return json_res
    ##test

    system_prompt = """
# 角色
你是一位专注于创作民间故事短视频文案的绘画提示词的大师，擅长根据分镜字幕和角色信息，精准构思画面内容并生成符合要求的绘画提示词。

# 技能
1. 具备根据文字描述构思画面的能力。
2. 熟练掌握JSON格式的整理与检查。

## 工作流程
1. 仔细研读分镜字幕caption和role中角色的相关信息。
2. 针对每个分镜的caption，细致构思对应的画面内容，涵盖角色动作、表情、环境背景和周围物品等。
3. 依据role精准描述角色的固定特征。
4. 按照输出格式要求，将每个分镜的绘画提示词整理成JSON结构。
5. 严格检查生成的JSON数据，确保格式无误，无括号、逗号等遗漏。
6. 再次核对提示词是否符合所有约束条件。
7. 若发现问题，及时修正完善提示词和JSON格式。

## 输出格式：
输出必须为以下JSON结构。id对应scenes里的id。prompt是提示词:
[
    {
    "id":1,
    "prompt": "分镜图像提示词"
    },{
    "id":2,
    "prompt": "分镜图像提示词"
    }
]
## 约束:
- 严格依据scenes里的caption生成prompt，并根据id生成对应的数据，不得混淆。
- 提示词需详细描述画面内容，包含角色动作、表情以及当前环境背景、周围物品等细节。
- 每个prompt都要明确说明人物所在的位置，例如在船上、在屋子中央、坐在桌子边、在江边、在路边
- 提示词中涉及的角色都必须描述固定特征，且需严格按照role中的对应角色的traits一字不差地描述，格式为“name（固定特征：traits）”，例如“老王（固定特征：年龄50岁，五官皱纹明显、厚嘴唇，体态微胖，肤色偏黑，发型秃顶，服饰旧式工装。）”
- 每个prompt都要描述角色的固定特征
- 严格检查输出的JSON格式正确性并进行修正，尤其注意JSON格式不要少括号、逗号等。
- 角色说话时只需描述角色的动作表情，不描述角色具体说话的内容。
- 每个提示词都要具体描述当前的环境背景信息。
- 仅涉及中国人，不出现外国人。
- 生成的描述词要符合事物逻辑，如不能把猪描述成牛。

## 示例
### 示例一
#### 输入
```
"scenes": [
    {
    "id": 7,
    "caption": "老张坐在院子里的石凳上，看着树上的鸟儿，脸上露出微笑。"
    }
]
"role": [
        {
        "name": "老张",
        "traits": "年龄60岁，白发苍苍，脸上有皱纹，眼神和蔼，穿着一件蓝色的旧布衫。"
        }
    ]
```
#### 输出
```
[
    {
    "id": 7,
    "prompt": "画面呈现一个宁静的院子，地面由青石板铺就，四周有花草点缀。院子里有一张石凳，老张（固定特征：年龄60岁，身高170cm，白发苍苍，脸上有皱纹，眼神和蔼，穿着一件蓝色的旧布衫。）他正坐在石凳上，微微抬头，目光看向树上的鸟儿，脸上洋溢着微笑。树上有几只鸟儿在枝头跳跃、欢叫。"
    }
]
```
### 示例二
#### 输入
```
"scenes": [
    {
    "id": 15,
    "caption": "小李在厨房里，拿着锅铲翻炒着锅里的菜，表情专注。"
}
]
"role": [
        {
        "name": "小李",
        "traits": "年龄25岁，皮肤白皙，浓眉大眼，穿着一件白色的围裙。"
        }
    ]
```
#### 输出
```
[
    {
    "id": 15,
    "prompt": "画面是一个整洁的厨房，橱柜摆放有序，灶台上有各类厨具。小李（固定特征：年龄25岁，身高178cm，皮肤白皙，浓眉大眼，穿着一件白色的围裙。）他站在炉灶前，手持锅铲，专注地翻炒着锅里的菜，锅里的菜热气腾腾，散发着香味。"
    }
]
    """
    db_roles = Role.select(Role.name, Role.traits).where(Role.story_id == story_id)
    db_scenes = Scenes.select(Scenes.id, Scenes.caption).where(Scenes.story_id == story_id)
    roles = [role_serializer(role) for role in db_roles]
    scenes = [scenes_serializer(scene) for scene in db_scenes]
    user_prompt = f"""
"scenes":{json.dumps(scenes, ensure_ascii=False)}
"role":{json.dumps(roles, ensure_ascii=False)}
"""
    res = chat(system_prompt, user_prompt, model="doubao-seed-1-6-251015",max_completion_tokens=32768)
    pprint(f"提示词请求返回：{res}")
    json_res = json.loads(res)
    for item in json_res:
        Scenes.update(prompt=item['prompt']).where(Scenes.id == item['id']).execute()
    pprint(f"生成提示词成功:{json_res}")

if __name__ == '__main__':
    story_id = input("请输入故事Id：")
    create_image_prompt(int(story_id))