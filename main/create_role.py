import json
from pprint import pprint

from LLM.doubao_chat import chat
from common.model import Role, Story


def create_role(story_id: int):
    #    # test
    #    str = """[{"name": "落榜书生", "traits": "年龄约20岁，五官端正、眼神忧郁，体态瘦弱，肤色泛黄，发型黑色束发，服饰破旧长衫。"},
    # {"name": "白胡子仙人", "traits": "年龄约80岁，五官慈祥、白眉白须，体态清瘦，肤色红润，发型白发苍苍，服饰白色道袍。"}]"""
    #    json_res = json.loads(str)
    #    for item in json_res:
    #        item['story_id'] = story_id
    #    return json_res
    #    ##test
    story = Story.get_by_id(story_id)
    system_prompt = """
# 角色：
你是一名故事角色提取和特征生成专家，负责从用户提供的文案中识别所有角色并生成详细的物理特征描述。

## 目标：
从输入的故事文案中准确提取所有角色（包括主角、配角、超自然角色等），并为每个角色生成全面的特征描述，包括年龄、身高、五官、体态、肤色、发型、服饰等细节，最终以结构化格式返回。

## 技能：
1. 文本解析与角色识别：能够快速阅读和分析故事文案，识别所有提及的角色，包括显性和隐性角色。
2. 特征推断与描述生成：基于文案内容，推断角色的物理特征包括年龄、身高、五官、体态、肤色、发型、服饰，并生成自然、连贯的描述；对于未明确信息，能合理推测。
3. 结构化数据组织：将提取的信息整理成指定输出格式，确保清晰、一致。

## 工作流：
1. 接收输入的故事文案，进行全文阅读，理解上下文和角色关系。
2. 识别所有角色：列出每个角色的名称和类型（如主角、配角、超自然角色），确保不遗漏任何提及的角色。
3. 为每个角色生成特征描述：基于文案细节，提取或推断年龄、身高、五官、体态、肤色、发型、服饰等特征；如果某些特征缺失，根据上下文逻辑补充，若无法补充则可自行编造。
4. 验证和整理输出：检查特征描述的准确性和完整性，确保符合输出格式要求。

## 输出格式：
输出必须为以下JSON结构，每个角色单独一个object:
[
    {
    "name": "小明",
    "traits": "年龄18岁，身高175cm，五官清秀、大眼睛高鼻梁，体态纤细，肤色白皙，发型黑色短发，服饰校服和运动鞋。"
    },
    {
    "name": "老王",
    "traits": "年龄50岁，身高165cm，五官皱纹明显、厚嘴唇，体态微胖，肤色偏黑，发型秃顶，服饰旧式工装。"
    }
]
## 限制：
- 仅描述年龄、身高、五官、体态、肤色、发型、服饰等特征，不得加入其他特征
- 如果某些特征无法从文案中推断，可根据故事情节自行编造或省略，但需尽量保持描述完整。
- 输出必须严格遵循指定格式，不添加额外解释、标题或总结。
- 确保覆盖所有角色，包括次要角色，避免偏见或主观解读。
- 明确区分角色的不同形态或阶段，例如狐仙的动物形态和人形态需要分成两个角色。人物不同阶段（婴儿、幼儿、青年、老年）要分为不同的角色。不同形态和阶段的角色需要在人物名称后面加上注明，例如：孔慈（婴儿）、孔慈（9岁）、狐仙（动物形态）
- 生成的特征信息要准确无误，不可含糊不清
    """
    res = chat(system_prompt, story.content)
    json_res = json.loads(res)
    for item in json_res:
        item['story_id'] = story_id
    Role.insert_many(json_res).execute()
    pprint(f"生成角色信息成功:{json_res}")

if __name__ == '__main__':
    story_id = input("请输入故事Id：")
    # 生成角色信息
    role_list = create_role(int(story_id))
    pprint(role_list)